SET ECHO ON
SET TIMING ON
SET FEEDBACK ON

SPOOL &1;

--============================================
-- 		ESPECIALIZACION BI & BIG DATA
--============================================
	
-- CARGA DE TABLA HM_DEUDACLIENTE

TRUNCATE TABLE HM_DEUDACLIENTE;

INSERT INTO HM_DEUDACLIENTE
(
	CODMES			 ,
	TIPREGISTRO		 ,
	CODSBSCLIENTE	 ,
	CODENTIDAD		 ,
	TIPCREDITO		 ,
	CODCUENTA		 ,
	CODPRODUCTO		 ,
	CODSUBPRODUCTO	 ,
	DIASATRASO		 ,
	SALDO			 ,
	CLASIFICACION	 
)
SELECT 
	A.CODMES			,
	A.TIPREGISTRO		,
	A.CODSBSCLIENTE	 	,
	A.CODENTIDAD		,
	A.TIPCREDITO		,
	A.CODCUENTA		 	,
	CASE 
	WHEN A.CODSUBPRODUCTO = 1 THEN 1
	WHEN A.CODSUBPRODUCTO = 2 THEN 2
	WHEN A.CODSUBPRODUCTO IN (3,4) THEN 3
	WHEN A.CODSUBPRODUCTO IN (5,6) THEN 4
	WHEN A.CODSUBPRODUCTO IN (7,8) THEN 5
	WHEN A.CODSUBPRODUCTO = 9 THEN 6
	END CODPRODUCTO	 	,
	A.CODSUBPRODUCTO		,
	A.DIASATRASO		,
	A.SALDO			    ,
	A.CLASIFICACION
FROM 
	(SELECT 
		REPLACE(CODMES,'"','')		CODMES			,
		TO_NUMBER(TIPREGISTRO)		TIPREGISTRO		,
		TO_NUMBER(CODSBSCLIENTE)	CODSBSCLIENTE	,
		TO_NUMBER(CODENTIDAD)		CODENTIDAD		,
		TIPCREDITO		        	,
		CODCUENTA                 	,
		CASE 
		WHEN SUBSTR(TRIM(CODCUENTA),4,1) IN ('1','3','4','5','6') AND SUBSTR(TRIM(CODCUENTA),1,2) ='14' AND TRIM(TIPCREDITO) ='09' THEN 1
		WHEN SUBSTR(TRIM(CODCUENTA),4,1) IN ('1','3','4','5','6') AND SUBSTR(TRIM(CODCUENTA),1,2) ='14' AND TRIM(TIPCREDITO) ='10' THEN 2
		WHEN SUBSTR(TRIM(CODCUENTA),4,1) IN ('1','3','4','5','6') AND SUBSTR(TRIM(CODCUENTA),1,2) ='14' AND TRIM(TIPCREDITO) ='13' AND SUBSTR(TRIM(CODCUENTA),7,2) NOT IN ('23','24', '25') THEN 3
		WHEN SUBSTR(TRIM(CODCUENTA),4,1) IN ('1','3','4','5','6') AND SUBSTR(TRIM(CODCUENTA),1,2) ='14' AND TRIM(TIPCREDITO) ='13' AND SUBSTR(TRIM(CODCUENTA),7,2) IN ('23','24', '25') THEN 4
		WHEN SUBSTR(TRIM(CODCUENTA),4,1) IN ('1','3','4','5','6') AND SUBSTR(TRIM(CODCUENTA),1,2) ='14' AND TRIM(TIPCREDITO) IN ('11','12') AND SUBSTR(TRIM(CODCUENTA),7,2) = ('06') AND SUBSTR(TRIM(CODCUENTA),7,4) <> '0602' THEN 5
		WHEN SUBSTR(TRIM(CODCUENTA),4,1) IN ('1','3','4','5','6') AND SUBSTR(TRIM(CODCUENTA),1,2) ='14' AND TRIM(TIPCREDITO) IN ('11','12') AND SUBSTR(TRIM(CODCUENTA),7,2) = ('06') AND SUBSTR(TRIM(CODCUENTA),7,4) = '0602' THEN 6
		WHEN SUBSTR(TRIM(CODCUENTA),4,1) IN ('1','3','4','5','6') AND SUBSTR(TRIM(CODCUENTA),1,2) ='14' AND TRIM(TIPCREDITO) IN ('11','12') AND SUBSTR(TRIM(CODCUENTA),7,2) = '02' THEN 7
		WHEN SUBSTR(TRIM(CODCUENTA),1,2) ='81' AND TRIM(TIPCREDITO) IN ('11','12') AND SUBSTR(TRIM(CODCUENTA),4,3) = '923' THEN 8
		ELSE 9
		END CODSUBPRODUCTO							,
		TO_NUMBER(DIASATRASO)	DIASATRASO			,
		TO_NUMBER(REPLACE(SALDO, '.', ','))	SALDO	,		
		TO_NUMBER(CLASIFICACION) CLASIFICACION
	FROM TMP_DEUDACLIENTE) A;

COMMIT;

DISCONNECT;
EXIT;